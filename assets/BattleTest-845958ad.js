import{M as k,r as b,aa as v,T as M,Z as E,Q as x,aP as I}from"./index-d3a8aa25.js";const d=.01,_=1e-6;class B{constructor(t){this.lcg=t,this.units=[]}init(){this.lcg.shuffle(this.units),this.units.forEach((t,n)=>{t.id=n})}iterate(){var n;this.units.forEach(s=>{s.life!==0&&s.checkAction(this.units)}),this.units.forEach(s=>{var e,a,r;if(s.life!==0)switch(s.action.type){case"move":{s.pos=s.action.target;break}case"attack":{const i=Math.max(1,(((e=s.unit.weapon)==null?void 0:e[0].damage)??0)-(((a=s.action.target.unit.armor)==null?void 0:a.defense)??0));s.action.target.life=Math.max(0,s.action.target.life-i),s.action={type:"idle",cooldown:((r=s.unit.weapon)==null?void 0:r[0].speed)||d};break}}}),this.units=this.units.filter(s=>s.life>0);const t={};this.units.forEach(s=>{t[s.group]=!0}),Object.keys(t).length===1&&((n=this.onFinish)==null||n.call(this,this))}}class c{constructor(t=0,n=0){this.x=t,this.y=n}add(t){return new c(this.x+t.x,this.y+t.y)}sub(t){return new c(this.x-t.x,this.y-t.y)}mul(t){return new c(this.x*t,this.y*t)}dis(){return Math.sqrt(this.x*this.x+this.y*this.y)}str(){return`${Math.round(this.x*1e4)/1e4},${Math.round(this.y*1e4)/1e4}`}norm(){const t=this.dis();return t===0?new c:this.mul(1/t)}}class S{constructor(t){this.id=-1,this.group=-1,this.life=t.health,this.unit=t,this.pos=new c(0,0),this.action={type:"idle",cooldown:d}}checkAction(t){var a,r;if(this.action.type==="idle"&&(this.action.cooldown-=d,Math.abs(this.action.cooldown)>_))return;const s=t.filter(i=>i.group!==this.group).map(i=>({unit:i,dis:this.pos.sub(i.pos).dis()})).sort((i,h)=>i.dis===h.dis?i.unit.id-h.unit.id:i.dis-h.dis)[0],e=(r=(a=this.unit)==null?void 0:a.weapon)==null?void 0:r[0];if(!e||!s){this.action={type:"idle",cooldown:d};return}if(s.dis>e.range){const i=s.unit.pos.sub(this.pos).norm().mul((this.unit.speed||1)*d),h=this.pos.add(i);let f=null,p=1/0;for(const o of t){const l=o.pos.sub(h).dis();if(o.id!==this.id&&l<(this.unit.size??0)+(o.unit.size??0)){p>l&&(f=o.pos,p=l);break}}if(!f)this.action={type:"move",target:h};else{const o=this.pos.sub(f).norm();this.action={type:"move",target:o.mul((this.unit.speed||1)*d).add(this.pos)}}}else this.action={type:"attack",target:s.unit}}}const z=k({__name:"BattleTest",setup(m){const t=b(null),n=new B(new E(1));function s(e){const a=new Path2D;return a.ellipse(0,0,5,5,0,0,Math.PI*2),e.fillStyle="white",e.strokeStyle="black",()=>{e.save(),e.fillRect(0,0,500,500),n.units.forEach(r=>{e.save();const i=r.life/r.unit.health;e.fillStyle=`rgb(${255-i*255}, ${255-i*255}, 255)`,e.translate(r.pos.x*50,r.pos.y*50),e.fill(a),e.stroke(a),e.restore()}),e.restore()}}return v(()=>{const a=t.value.getContext("2d"),r=s(a),i=I.陆战队员,h=(o,l,g)=>{const u=new S(i);return u.pos=new c(o,l),u.group=g,u},f=()=>new c(Math.random()-.5,Math.random()-.5).mul(2);for(let o=0;o<2;o++){const l=o?9:1,g=new c(l,l);for(let u=0;u<50;u++){const{x:y,y:w}=g.add(f());n.units.push(h(y,w,o))}}n.init();const p=setInterval(()=>{n.iterate(),r()},10);n.onFinish=()=>{clearInterval(p)}}),(e,a)=>(x(),M("canvas",{width:"500",height:"500",ref_key:"canvasEl",ref:t},null,512))}});export{z as default};
