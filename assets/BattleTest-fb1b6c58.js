import{M as k,r as b,aa as v,T as M,Z as E,Q as x,aP as _}from"./index-b12d60c0.js";const d=.01,B=1e-6;class I{constructor(t){this.lcg=t,this.units=[]}init(){this.lcg.shuffle(this.units),this.units.forEach((t,n)=>{t.id=n})}iterate(){var n;this.units.forEach(s=>{s.life!==0&&s.checkAction(this.units)}),this.units.forEach(s=>{var e,o,a;if(s.life!==0)switch(s.action.type){case"move":{s.pos=s.action.target;break}case"attack":{const i=Math.max(1,(((e=s.unit.weapon)==null?void 0:e[0].damage)||0)-(((o=s.action.target.unit.armor)==null?void 0:o.defense)||0));s.action.target.life=Math.max(0,s.action.target.life-i),s.action={type:"idle",cooldown:((a=s.unit.weapon)==null?void 0:a[0].speed)||d};break}}}),this.units=this.units.filter(s=>s.life>0);const t={};this.units.forEach(s=>{t[s.group]=!0}),Object.keys(t).length===1&&((n=this.onFinish)==null||n.call(this,this))}}class r{constructor(t=0,n=0){this.x=t,this.y=n}add(t){return new r(this.x+t.x,this.y+t.y)}sub(t){return new r(this.x-t.x,this.y-t.y)}mul(t){return new r(this.x*t,this.y*t)}dis(){return Math.sqrt(this.x*this.x+this.y*this.y)}str(){return`${Math.round(this.x*1e4)/1e4},${Math.round(this.y*1e4)/1e4}`}norm(){const t=this.dis();return t===0?new r:this.mul(1/t)}}class S{constructor(t){this.id=-1,this.group=-1,this.life=t.health,this.unit=t,this.pos=new r(0,0),this.action={type:"idle",cooldown:d}}checkAction(t){var o,a;if(this.action.type==="idle"&&(this.action.cooldown-=d,Math.abs(this.action.cooldown)>B))return;const s=t.filter(i=>i.group!==this.group).map(i=>({unit:i,dis:this.pos.sub(i.pos).dis()})).sort((i,h)=>i.dis===h.dis?i.unit.id-h.unit.id:i.dis-h.dis)[0],e=(a=(o=this.unit)==null?void 0:o.weapon)==null?void 0:a[0];if(!e||!s){this.action={type:"idle",cooldown:d};return}if(s.dis>e.range){const i=s.unit.pos.sub(this.pos).norm().mul((this.unit.speed||1)*d),h=this.pos.add(i);let p=null;for(const c of t)if(c.id!==this.id&&c.pos.sub(h).dis()<(this.unit.size||0)+(c.unit.size||0)){p=c.pos;break}p?this.action={type:"move",target:this.pos.sub(p).norm().mul((this.unit.speed||1)*d).add(this.pos)}:this.action={type:"move",target:h}}else this.action={type:"attack",target:s.unit}}}const z=k({__name:"BattleTest",setup(m){const t=b(null),n=new I(new E(1));function s(e){const o=new Path2D;return o.ellipse(0,0,5,5,0,0,Math.PI*2),e.fillStyle="white",e.strokeStyle="black",()=>{e.save(),e.fillRect(0,0,500,500),n.units.forEach(a=>{e.save();const i=a.life/a.unit.health;e.fillStyle=`rgb(${255-i*255}, ${255-i*255}, 255)`,e.translate(a.pos.x*50,a.pos.y*50),e.fill(o),e.stroke(o),e.restore()}),e.restore()}}return v(()=>{const o=t.value.getContext("2d"),a=s(o),i=_.陆战队员,h=(l,f,g)=>{const u=new S(i);return u.pos=new r(l,f),u.group=g,u},p=()=>new r(Math.random()-.5,Math.random()-.5).mul(2);for(let l=0;l<2;l++){const f=l?9:1,g=new r(f,f);for(let u=0;u<50;u++){const{x:y,y:w}=g.add(p());n.units.push(h(y,w,l))}}n.init();const c=setInterval(()=>{n.iterate(),a()},10);n.onFinish=()=>{clearInterval(c)}}),(e,o)=>(x(),M("canvas",{width:"500",height:"500",ref_key:"canvasEl",ref:t},null,512))}});export{z as default};
